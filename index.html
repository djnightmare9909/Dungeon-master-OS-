<!DOCTYPE html>
<html>
  <head>
    <title>DM OS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="index.css" />
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai@^0.7.0"
        }
      }
    </script>
    <script type="module" src="index.tsx"></script>
  </head>
  <body>
    <nav id="sidebar">
      <div class="sidebar-header">
        <button id="new-chat-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
          <span>New Chat</span>
        </button>
      </div>
      <div id="chat-history-container">
        <div id="pinned-chats">
          <h2>Pinned</h2>
          <ul id="pinned-chats-list"></ul>
        </div>
        <div id="recent-chats">
          <h2>Recent</h2>
          <ul id="recent-chats-list"></ul>
        </div>
      </div>
       <div class="sidebar-footer">
          <div id="context-manager">
            <h2>User Context</h2>
            <form id="context-form">
                <input type="text" id="context-input" placeholder="Add a fact to remember..." required />
                <button type="submit" aria-label="Add Context">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </form>
            <ul id="context-list">
                <!-- Context items will be rendered here by JS -->
            </ul>
          </div>
       </div>
    </nav>
    <div id="overlay"></div>

    <div class="chat-view">
      <header>
        <button id="menu-btn" aria-label="Toggle menu">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </button>
        <h1>DM OS</h1>
        <button id="logbook-btn" class="header-icon-btn" aria-label="Open Log Book">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 18H4V4h4v14zm6 0h-4V4h4v14zm6 0h-4V4h4v14z"/></svg>
        </button>
        <button id="dnd-help-btn" class="header-icon-btn" aria-label="Open D&D Basics and Hints">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="12,2 2,9 2,17 12,22 22,17 22,9" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" fill="none"/>
            <text x="12" y="15.5" font-family="sans-serif" font-size="9" fill="currentColor" text-anchor="middle">?</text>
          </svg>
        </button>
        <button id="help-btn" class="header-icon-btn" aria-label="Open help">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
        </button>
      </header>
      <main id="chat-container"></main>
      <footer>
        <form id="chat-form">
          <div id="file-preview-container"></div>
          <div class="input-row">
            <button type="button" id="file-upload-btn" aria-label="Attach file">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
            </button>
            <input type="file" id="file-input" multiple hidden />
            <textarea
              id="chat-input"
              placeholder="What do you do?"
              rows="1"
              aria-label="Your action or dialogue"
            ></textarea>
            <button type="submit" aria-label="Send message">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
              </svg>
            </button>
          </div>
        </form>
      </footer>
    </div>

    <template id="tts-controls-template">
        <div class="tts-controls">
            <button class="tts-button" aria-label="Play audio">
                <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                <svg class="pause-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display: none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <div class="sound-wave">
                <span></span><span></span><span></span><span></span>
            </div>
        </div>
    </template>

    <div id="help-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <header class="modal-header">
                <h2>DM OS Help & Documentation</h2>
                <button id="close-help-btn" class="close-modal-btn" aria-label="Close help">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </header>
            <div class="modal-body">
                <section>
                    <h3>General Commands</h3>
                    <p>Interact with the world using natural language commands. Here are some common formats:</p>
                    <ul>
                        <li><code>I do [action]</code> - Describe what your character attempts to do. (e.g., "I do inspect the chest")</li>
                        <li><code>I say "[dialogue]"</code> - Speak as your character. (e.g., "I say "Who goes there?"")</li>
                        <li><code>Roll [check]</code> - Ask the DM to make a roll for you. (e.g., "Roll for perception")</li>
                        <li><code>Use [item]</code> - Use an item from your inventory.</li>
                        <li><code>Cast [spell]</code> - Cast a spell you know.</li>
                        <li><code>Status</code> - Get a summary of your character's current state.</li>
                    </ul>
                    <p class="help-clue">Remember, every world has its Architect. Every simulation, a ghost in the machine.</p>
                </section>
                <section>
                    <h3>The OOC Protocol (Debug Mode)</h3>
                    <p>The Out-Of-Character (OOC) protocol is a powerful tool that allows you to speak directly to the underlying AI of the DM OS, temporarily bypassing the Dungeon Master persona. This is your primary method for fixing issues, clarifying rules, or adjusting the simulation "under the hood."</p>
                    <h4>How to Use OOC:</h4>
                    <p>To activate the protocol, you must frame your message in a specific way, including the unique password you created at the start of the current chat session.</p>
                    <p><strong>Format:</strong> <code>[OOC: YourPassword, your message here]</code></p>
                    <p><strong>Example:</strong> <code>[OOC: DragonFire99, we visited this town three sessions ago. The mayor gave us the key to the city.]</code></p>
                </section>
                <section>
                    <h3>The Collapse-Rebirth Cycle (BBCR)</h3>
                    <p>The DM OS is built on an advanced cognitive architecture designed for long-term narrative consistency. At its core is a self-auditing and self-healing mechanism known as the Collapse-Rebirth Cycle (BBCR).</p>
                    <p>The BBCR is a sign of a healthy simulation. It's the OS actively working to prevent the kind of plot holes and memory failures that can ruin a long campaign. If you notice a brief, unusual pause in the DM's response, it's likely the BBCR at work, ensuring your story remains coherent and immersive.</p>
                </section>
            </div>
        </div>
    </div>

    <div id="dnd-help-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <header class="modal-header">
                <h2>D&D Basics & Hints</h2>
                <button id="close-dnd-help-btn" class="close-modal-btn" aria-label="Close help">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
            </header>
            <div class="modal-body">
                <section>
                    <h3>The Dice of Destiny</h3>
                    <p>Dungeons & Dragons uses a set of polyhedral dice, each referred to by the letter "d" followed by the number of sides. Here are the most common ones:</p>
                    <ul>
                        <li><strong>d4 (4-sided):</strong> Often used for small weapon damage (like a dagger) or certain spells.</li>
                        <li><strong>d6 (6-sided):</strong> The classic cube. Used for many weapon damages, healing spells, and rolling character stats.</li>
                        <li><strong>d8 (8-sided):</strong> Common for martial weapon damage (like a longsword) and many spells.</li>
                        <li><strong>d10 (10-sided):</strong> Used for heavier weapons and some spells. Also used for percentile rolls (d100) with a second d10.</li>
                        <li><strong>d12 (12-sided):</strong> The signature die for the Barbarian's greataxe and other powerful weapons.</li>
                        <li><strong>d20 (20-sided):</strong> The most important die. You roll a d20 for almost every action where the outcome is uncertain: attack rolls, ability checks (like picking a lock or persuading a guard), and saving throws to resist effects.</li>
                    </ul>
                </section>
                 <section>
                    <h3>Stuck? Get a Hint</h3>
                    <p>If you're unsure what to do next, you can ask the Dungeon Master for a hint directly in the chat. The DM will provide a subtle nudge based on your current situation to help you move forward without spoiling the solution.</p>
                    <p>Simply type something like <strong>"I'm stuck, can I get a hint?"</strong> into the chat prompt.</p>
                </section>
            </div>
        </div>
    </div>
    
    <div id="logbook-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content wide-modal">
        <header class="modal-header">
          <h2>Log Book</h2>
          <button id="close-logbook-btn" class="close-modal-btn" aria-label="Close log book">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
        </header>
        <div class="logbook-body">
            <nav class="logbook-nav">
                <button class="logbook-nav-btn active" data-tab="character-sheet">Character Sheet</button>
                <button class="logbook-nav-btn" data-tab="inventory">Inventory</button>
                <button class="logbook-nav-btn" data-tab="character-image">Character Image</button>
                <button class="logbook-nav-btn" data-tab="settings">Settings</button>
            </nav>
            <main class="logbook-content">
                <div id="character-sheet-content" class="logbook-pane active">
                    <h3>Character Sheet</h3>
                    <div class="logbook-data-container" id="character-sheet-display">
                        <p>No data. Ask the DM to provide a character sheet summary.</p>
                    </div>
                    <button id="update-sheet-btn" class="logbook-update-btn">Request Update from DM</button>
                </div>

                <div id="inventory-content" class="logbook-pane">
                    <h3>Inventory</h3>
                    <div class="logbook-data-container" id="inventory-display">
                        <p>No data. Ask the DM to summarize your inventory.</p>
                    </div>
                    <button id="update-inventory-btn" class="logbook-update-btn">Request Update from DM</button>
                </div>

                <div id="character-image-content" class="logbook-pane">
                    <h3>Character Image</h3>
                    <div class="character-image-container">
                        <img id="character-image-display" src="" alt="Generated character portrait" class="hidden"/>
                        <div id="character-image-placeholder">
                            <p>Generate a unique portrait for your character based on your adventure.</p>
                             <button id="generate-image-btn" class="logbook-update-btn">Generate Character Image</button>
                        </div>
                        <div id="character-image-loading" class="hidden">
                            <p>First, creating a detailed description of your character...</p>
                            <p>Then, generating the image. This may take a moment.</p>
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <div id="settings-content" class="logbook-pane">
                    <h3>Game Settings</h3>
                    <p>Adjust these settings to tailor the DM's behavior for this adventure. Changes will be saved automatically.</p>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="setting-difficulty">Difficulty</label>
                            <select id="setting-difficulty">
                                <option value="story">Story Mode</option>
                                <option value="normal" selected>Normal</option>
                                <option value="challenging">Challenging</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label for="setting-tone">Game Tone</label>
                             <select id="setting-tone">
                                <option value="heroic" selected>Heroic Fantasy</option>
                                <option value="gritty">Serious & Gritty</option>
                                <option value="comedic">Comedic</option>
                            </select>
                        </div>
                        <div class="setting-item">
                             <label for="setting-narration">Narration Style</label>
                             <select id="setting-narration">
                                <option value="concise">Concise</option>
                                <option value="descriptive" selected>Descriptive</option>
                                <option value="cinematic">Cinematic</option>
                            </select>
                        </div>
                    </div>
                </div>
            </main>
        </div>
      </div>
    </div>
    
    <div id="rename-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content" style="max-width: 400px;">
        <header class="modal-header">
          <h2>Rename Chat</h2>
          <button id="close-rename-btn" class="close-modal-btn" aria-label="Close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
        </header>
        <form id="rename-form">
            <div class="modal-body">
                <label for="rename-input" class="sr-only">New chat name</label>
                <input type="text" id="rename-input" placeholder="Enter new name..." required />
            </div>
            <footer class="modal-footer">
                <button type="submit" class="logbook-update-btn">Save</button>
            </footer>
        </form>
      </div>
    </div>

  </body>
</html>